<!--
  - SPDX-FileCopyrightText: 2021 Nextcloud GmbH and Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<template>
	<section class="member-list">
		<NcEmptyContent v-if="loading" class="empty-content" :name="t('contacts', 'Loading members list â€¦')">
			<template #icon>
				<IconLoading :size="20" />
			</template>
		</NcEmptyContent>

		<NcEmptyContent v-else-if="!circle.isMember"
			class="empty-content"
			:name="t('contacts', 'The list of members is only visible to members of this team')">
			<template #icon>
				<IconContact :size="20" />
			</template>
		</NcEmptyContent>

		<NcEmptyContent v-else-if="!hasMembers"
			class="empty-content"
			:name="t('contacts', 'You currently have no access to the member list')">
			<template #icon>
				<IconContact :size="20" />
			</template>
		</NcEmptyContent>

		<template v-else>
			<NcTextField v-if="flatList.length > 20"
				v-model="searchQuery"
				:label="t('contacts', 'Search among current members')"
				trailing-button-icon="close"
				:show-trailing-button="searchQuery !== ''"
				@trailing-button-click="clearSearchField">
				<IconSearch :size="20" />
			</NcTextField>
			<RecycleScroller ref="scroller"
				class="member-scroller"
				:items="filteredList"
				:item-size="56"
				:grid-items="gridItems"
				:item-secondary-size="itemSecondarySize">
				<template #default="{ item }">
					<MemberGridItem :key="`member-grid-item-${item.id}`"
						:member="item"
						:is-team="!item.isUser" />
				</template>
				<template #empty v-if="!filteredList.length">
					<div class="empty-search-results">
						<NcEmptyContent :name="t('contacts', 'No results found')">
							<template #icon>
								<IconSearch :size="20" />
							</template>
						</NcEmptyContent>
					</div>
				</template>
			</RecycleScroller>
		</template>

		<!-- member picker -->
		<EntityPicker v-if="showPicker"
			ref="entityPicker"
			v-model:selection="pickerSelection"
			:confirm-label="t('contacts', 'Add to {team}', { team: circle.displayName })"
			:title-label="t('contacts', 'Invite members to {team}', { team: circle.displayName })"
			:data-types="pickerTypes"
			:data-set="filteredPickerData"
			:internal-search="false"
			:loading="pickerLoading"
			@close="resetPicker"
			@search="onSearch"
			@submit="onPickerPick" />
	</section>
</template>

<script lang="ts">
import {
	NcEmptyContent,
	isMobile,
	NcLoadingIcon as IconLoading,
	NcTextField
} from '@nextcloud/vue'
import { RecycleScroller } from 'vue-virtual-scroller'
import 'vue-virtual-scroller/dist/vue-virtual-scroller.css'

import MemberGridItem from './MemberGridItem.vue'
import EntityPicker from '../EntityPicker/EntityPicker.vue'
import IconContact from 'vue-material-design-icons/AccountMultipleOutline.vue'
import IconSearch from 'vue-material-design-icons/Magnify.vue'

import RouterMixin from '../../mixins/RouterMixin.js'

import { showError, showWarning } from '@nextcloud/dialogs'
import { subscribe } from '@nextcloud/event-bus'
import { t } from '@nextcloud/l10n'
import { getRecommendations, getSuggestions } from '../../services/collaborationAutocompletion.js'
import { SHARES_TYPES_MEMBER_MAP, CIRCLES_MEMBER_GROUPING } from '../../models/constants'
import { defineComponent } from 'vue'
import IsMobileMixin from '../../mixins/IsMobileMixin.ts'

export default defineComponent({
	name: 'MemberList',

	components: {
		EntityPicker,
		IconContact,
		IconLoading,
		IconSearch,
		MemberGridItem,
		NcEmptyContent,
		RecycleScroller,
		NcTextField,
	},

	mixins: [IsMobileMixin, RouterMixin],

	props: {
		list: {
			type: Array,
			required: true,
		},

		loading: {
			type: Boolean,
			default: false,
		},
	},

	data() {
		return {
			pickerLoading: false,
			showPicker: false,
			showPickerIntro: true,

			recommendations: [],
			pickerCircle: null,
			pickerData: [],
			pickerSelection: {},
			pickerTypes: CIRCLES_MEMBER_GROUPING,
			windowWidth: window.innerWidth,
			searchQuery: '',
		}
	},

	computed: {
		/**
		 * Return the current circle
		 *
		 * @return {object}
		 */
		circle() {
			return this.$store.getters.getCircle(this.selectedCircle)
		},

		filteredPickerData() {
			return this.pickerData.filter(entity => {
				const type = SHARES_TYPES_MEMBER_MAP[entity.shareType]
				const list = this.list.filter(({ userType }) => userType === type)
				if (list) {
					return list.find((member) => member.userId === entity.shareWith) === undefined
				}
				// If the type doesn't exists, there is no member of this type
				return true
			})
		},

		flatList() {
			const teams = this.list.filter(member => !member.isUser)
			const users = this.list.filter(member => member.isUser)
			return [...teams, ...users]
		},

		filteredList() {
			const query = this.searchQuery.toLowerCase()

			return this.flatList.filter(member =>
				!this.searchQuery || member.displayName.toLowerCase().includes(query)
			)
		},

		hasMembers() {
			return this.flatList.length > 0
		},

		gridItems() {
			if (this.windowWidth < 768) {
				// undefined means that the grid will be rendered as a list
				return undefined
			}

			return 2
		},

		itemSecondarySize() {
			if (this.windowWidth < 768) {
				// undefined means that the grid will be rendered as a list
				return undefined
			}

			// The maximum width of the member list is 500px,
			// so with two columns, each column is 242px wide (with scroll)
			return 242
		},
	},

	mounted() {
		subscribe('contacts:circles:append', this.onShowPicker)
		subscribe('guests:user:created', this.onGuestCreated)

		window.addEventListener('resize', this.onResize)
	},

	beforeDestroy() {
		window.removeEventListener('resize', this.onResize)
	},

	methods: {
		onResize() {
			this.windowWidth = window.innerWidth
		},

		clearSearchField() {
			this.searchQuery = ''
		},

		/**
		 * Show picker and fetch for recommendations
		 * Cache the circleId in case the url change or something
		 * and make sure we add them to the desired circle.
		 *
		 * @param {string} circleId the circle id to add members to
		 */
		async onShowPicker(circleId) {
			this.showPicker = true
			this.pickerLoading = true
			this.pickerCircle = circleId

			try {
				const results = await getRecommendations()
				// cache recommendations
				this.recommendations = results
				this.pickerData = results
			} catch (error) {
				console.error('Unable to get the recommendations list', error)
				// Do not show the error, let the user search
				// showError(t('contacts', 'Unable to get the recommendations list'))
			} finally {
				this.pickerLoading = false
			}
		},

		/**
		 * On EntityPicker search.
		 * Returns recommendations if empty
		 *
		 * @param {string} term the searched term
		 */
		async onSearch(term) {
			if (term.trim() === '') {
				this.pickerData = this.recommendations
				return
			}

			this.pickerLoading = true

			try {
				const results = await getSuggestions(term)
				this.pickerData = results
			} catch (error) {
				console.error('Unable to get the results', error)
				showError(t('contacts', 'Unable to get the results'))
			} finally {
				this.pickerLoading = false
			}
		},

		/**
		 * On picker submit
		 *
		 * @param {Array} selection the selection to add to the circle
		 */
		async onPickerPick(selection) {
			this.logger.info('Adding selection to circle', { selection, pickerCircle: this.pickerCircle })

			this.pickerLoading = true

			selection = selection.map(entry => ({
				id: entry.shareWith,
				type: SHARES_TYPES_MEMBER_MAP[entry.shareType],
			}))

			try {
				const members = await this.$store.dispatch('addMembersToCircle', { circleId: this.pickerCircle, selection })

				if (members.length < selection.length) {
					showWarning(t('contacts', 'Some members could not be added'))
					// TODO filter successful members and edit selection
					this.pickerSelection = {}
					return
				}

				this.resetPicker()
			} catch (error) {
				showError(t('contacts', 'There was an issue adding members to the team'))
				console.error('There was an issue adding members to the circle', this.pickerCircle, error)
			} finally {
				this.pickerLoading = false
			}
		},

		/**
		 * Reset picker related variables
		 */
		resetPicker() {
			this.showPicker = false
			this.pickerCircle = null
			this.pickerData = []
			this.pickerSelection = {}
		},

		async onGuestCreated(guest) {
			const results = await getSuggestions(guest.username)
			this.$refs.entityPicker.onClick(results[0])
		},
	},
})
</script>

<style lang="scss" scoped>
.member-list {
	// Make virtual scroller scrollable
	max-height: 100%;
	max-width: 900px;
	overflow: auto;

	:deep(.empty-content) {
		margin: auto;
	}
}

.member-scroller {
	height: 100%;
	max-height: 200px;
}

.empty-content {
	height: 100%;
}

.empty-search-results {
	margin-top: 2rem;
}
</style>
